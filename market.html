<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Salt's Market â€” Viewer</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Salt's Market</h1>
        <div class="muted">Prices are Negotiable and NOT FINAL</div>
      </div>
    </div>

    <div class="controls" role="region" aria-label="controls">
      <label class="control">ðŸ”Ž <input id="search" type="search" placeholder="Search items" /></label>
      <label class="control">Sort:
        <select id="sort" aria-label="Sort">
          <option value="new">Newest</option>
          <option value="name">Name Aâ†’Z</option>
          <option value="price">Price Lowâ†’High</option>
        </select>
      </label>
      <button id="refresh" class="control btn">Refresh</button>
    </div>
  </header>

  <main>
    <div id="grid" class="grid" role="list"></div>
    <div id="empty" style="display:none">No items found</div>
  </main>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="viewer" role="dialog" aria-modal="true"><img id="viewImg" alt=""></div>
  <button class="close" data-close aria-label="Close">âœ•</button>
</div>

<script>
(() => {
  const GIST_RAW_URL = "https://gist.githubusercontent.com/SaltAndViChips/8abb282bb5818fc1f1f8728d801df383/raw/inventory.json";
  const PROXY = "https://api.allorigins.win/raw?url=";
  const AUTO_REFRESH_MS = 10000;

  let records = [];

  function qs(id){ return document.getElementById(id); }

  function toImgurDirect(link){
    if(!link) return "";
    try{
      let m = link.match(/i\.imgur\.com\/([a-zA-Z0-9]{5,10})(?:\.(jpg|jpeg|png|gif|webp))?/);
      if(m) return `https://i.imgur.com/${m[1]}.${m[2]||'jpg'}`;
      m = link.match(/imgur\.com\/([a-zA-Z0-9]{5,10})/);
      if(m) return `https://i.imgur.com/${m[1]}.jpg`;
      return link;
    }catch(e){ return link; }
  }

  async function loadFromGist(){
    try{
      const res = await fetch(PROXY + encodeURIComponent(GIST_RAW_URL) + "&_=" + Date.now(), { cache: "no-store" });
      if(!res.ok) throw new Error("network "+res.status);
      const data = await res.json();
      if(!Array.isArray(data)) return [];
      return data.map((it, idx) => ({
        name: String(it.name||""),
        imgur: toImgurDirect(it.img || it.imgur || ""),
        price: Math.floor(Number(it.price)||0),
        SaltOwned: !!it.SaltOwned,
        key: "g_" + idx + "_" + Math.random().toString(36).slice(2),
        createdAt: Date.now()
      }));
    }catch(e){
      console.warn("loadFromGist failed:", e);
      return [];
    }
  }

  function fmt(n){ return Number(n).toLocaleString(); }

  function render(){
    const q = (qs("search").value||"").toLowerCase();
    const sort = qs("sort").value;
    let list = [...records];
    if(q) list = list.filter(r => (r.name||"").toLowerCase().includes(q));
    list.sort((a,b)=>{
      if(sort==="name") return (a.name||"").localeCompare(b.name||"");
      if(sort==="price") return (a.price||0) - (b.price||0);
      return (b.createdAt||0) - (a.createdAt||0);
    });
    const grid = qs("grid");
    grid.innerHTML = "";
    if(list.length === 0){ qs("empty").style.display = "block"; return; } else qs("empty").style.display = "none";
    for(const rec of list){
      const card = document.createElement("article");
      card.className = "card" + (rec.SaltOwned ? " salt-owned" : "");
      card.setAttribute("data-key", rec.key);

      const thumb = document.createElement("div");
      thumb.className = "thumb btn";
      const img = document.createElement("img");
      img.src = rec.imgur || ""; img.alt = rec.name || "";
      thumb.appendChild(img);

      const label = document.createElement("div");
      label.className = "label";

      const titleRow = document.createElement("div");
      titleRow.className = "title-row";
      const title = document.createElement("div");
      title.className = "title"; title.textContent = rec.name || "(unnamed)";
      titleRow.appendChild(title);
      if(rec.SaltOwned){
        const star = document.createElement("div");
        star.className = "star";
        star.textContent = "â˜…";
        titleRow.appendChild(star);
      }
      label.appendChild(titleRow);

      const price = document.createElement("div");
      price.className = "price";
      price.textContent = `${fmt(rec.price||0)} IC`;
      label.appendChild(price);

      card.appendChild(thumb);
      card.appendChild(label);
      grid.appendChild(card);

      thumb.addEventListener("click", () => openLightbox(rec));
    }
  }

  function openLightbox(rec){
    const viewerImg = qs("viewImg");
    viewerImg.src = rec.imgur || "";
    document.getElementById("lightbox").classList.add("active");
    document.getElementById("lightbox").style.display = "block";
  }
  function closeLightbox(){ document.getElementById("lightbox").classList.remove("active"); document.getElementById("lightbox").style.display = "none"; qs("viewImg").src = ""; }

  async function refresh(){
    const btn = qs("refresh");
    btn.textContent = "Refreshing...";
    btn.disabled = true;
    try{
      const gistItems = await loadFromGist();
      records = gistItems;
      render();
    }catch(e){ console.warn(e); }
    btn.textContent = "Refresh"; btn.disabled = false;
  }

  qs("search").addEventListener("input", render);
  qs("sort").addEventListener("change", render);
  qs("refresh").addEventListener("click", refresh);
  document.addEventListener("click", (e)=>{ if(e.target.matches("[data-close]")||e.target.closest("[data-close]")) closeLightbox(); });
  window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeLightbox(); });

  // initial load + auto refresh
  (async ()=>{ await refresh(); setInterval(refresh, AUTO_REFRESH_MS); })();
})();
</script>
</body>
</html>
