<script>
const GIST_RAW_URL = "https://gist.githubusercontent.com/SaltAndViChips/8abb282bb5818fc1f1f8728d801df383/raw/inventory.json";
let records = [];

async function loadItems() {
  try {
    const res = await fetch(GIST_RAW_URL + "?t=" + Date.now(), { cache: "no-store" });
    if(!res.ok) throw new Error("Failed to fetch Gist");
    const data = await res.json();
    return data.map(it => ({
      name: it.name,
      imgur: it.img || "",
      price: it.price,
      key: Math.random().toString(36).slice(2),
      createdAt: Date.now()
    }));
  } catch(e) {
    console.warn("Failed to fetch Gist:", e);
    return [];
  }
}

function imgUrl(link){
  const m = link.match(/imgur\.com\/([a-zA-Z0-9]{5,10})/);
  return m ? `https://i.imgur.com/${m[1]}.jpg` : link;
}

function render(){
  const q = document.getElementById("search").value.toLowerCase();
  const sort = document.getElementById("sort").value;
  let list = [...records];
  if(q) list = list.filter(r=>r.name.toLowerCase().includes(q));

  list.sort((a,b)=>{
    if(sort==="name") return a.name.localeCompare(b.name);
    if(sort==="price") return a.price - b.price;
    return b.createdAt - a.createdAt;
  });

  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  for(const rec of list){
    grid.innerHTML += `
      <article class="card">
        <div class="thumb btn" data-key="${rec.key}">
          <img src="${imgUrl(rec.imgur)}" alt="${rec.name}">
        </div>
        <div class="label">
          <div class="title">${rec.name}</div>
          <div class="muted">${Math.floor(rec.price)} IC</div>
        </div>
      </article>`;
  }
  document.getElementById("empty").style.display = list.length ? "none" : "block";
}

document.addEventListener("click", e=>{
  if(e.target.matches("[data-close]")) return closeLightbox();
  const t = e.target.closest("[data-key]");
  if(!t) return;
  const rec = records.find(r=>r.key===t.dataset.key);
  if(!rec) return;

  const img = t.querySelector("img");
  const r = img.getBoundingClientRect();
  const viewer = document.querySelector(".viewer");
  const viewImg = document.getElementById("viewImg");
  viewImg.src = imgUrl(rec.imgur);
  viewer.style.width = r.width+"px";
  viewer.style.height = r.height+"px";
  viewer.style.top = r.top+"px";
  viewer.style.left = r.left+"px";
  viewer.style.transform = "translate(0,0)";
  document.getElementById("lightbox").classList.add("active");

  requestAnimationFrame(()=>{
    viewer.style.width = window.innerWidth*0.8+"px";
    viewer.style.height = window.innerHeight*0.8+"px";
    viewer.style.top = "50%";
    viewer.style.left = "50%";
    viewer.style.transform = "translate(-50%,-50%)";
  });
});

function closeLightbox(){
  document.getElementById("lightbox").classList.remove("active");
  document.getElementById("viewImg").src = "";
}

document.getElementById("search").addEventListener("input", render);
document.getElementById("sort").addEventListener("change", render);

async function refreshItems(){
  const btn = document.getElementById("refresh");
  btn.textContent = "Refreshing...";
  btn.disabled = true;
  const items = await loadItems();
  if(items.length){
    records = items;
    render();
  }
  btn.textContent = "Refresh";
  btn.disabled = false;
}

// Bind refresh button
document.getElementById("refresh").addEventListener("click", refreshItems);

// Auto-refresh every 10 seconds
setInterval(refreshItems, 10000);

// Initial load
refreshItems();
</script>
